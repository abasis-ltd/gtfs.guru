<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GTFS Validator - WASM Demo</title>
  <style>
    :root {
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --text: #333333;
      --text-muted: #666666;
      --border: #e0e0e0;
      --primary: #1976d2;
      --error: #d32f2f;
      --error-bg: #ffebee;
      --warning: #f57c00;
      --warning-bg: #fff3e0;
      --info: #1976d2;
      --info-bg: #e3f2fd;
      --success: #388e3c;
      --success-bg: #e8f5e9;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 1rem;
    }

    .version {
      display: inline-block;
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    .drop-zone {
      border: 3px dashed var(--border);
      border-radius: 12px;
      padding: 3rem 2rem;
      text-align: center;
      background: var(--card-bg);
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .drop-zone:hover {
      border-color: var(--primary);
    }

    .drop-zone.dragover {
      border-color: var(--primary);
      background: var(--info-bg);
    }

    .drop-zone p {
      margin: 0.5rem 0;
      color: var(--text-muted);
    }

    .drop-zone .icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    input[type="file"] {
      display: none;
    }

    .file-label {
      display: inline-block;
      background: var(--primary);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      margin-top: 1rem;
    }

    .file-label:hover {
      opacity: 0.9;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 3rem;
      background: var(--card-bg);
      border-radius: 12px;
      margin-top: 2rem;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .results {
      display: none;
      margin-top: 2rem;
    }

    .results.show {
      display: block;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat {
      background: var(--card-bg);
      padding: 1.25rem;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .stat.valid {
      background: var(--success-bg);
      color: var(--success);
    }

    .stat.invalid {
      background: var(--error-bg);
      color: var(--error);
    }

    .stat.errors {
      color: var(--error);
    }

    .stat.warnings {
      color: var(--warning);
    }

    .stat.info {
      color: var(--info);
    }

    .notices-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .notices-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .notices-header h2 {
      font-size: 1.25rem;
    }

    .filter-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .filter-btn {
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: transparent;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.15s;
    }

    .filter-btn:hover {
      background: var(--bg);
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .notices-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .notice {
      padding: 1rem;
      margin-bottom: 0.75rem;
      border-radius: 8px;
      border-left: 4px solid;
    }

    .notice.ERROR {
      background: var(--error-bg);
      border-left-color: var(--error);
    }

    .notice.WARNING {
      background: var(--warning-bg);
      border-left-color: var(--warning);
    }

    .notice.INFO {
      background: var(--info-bg);
      border-left-color: var(--info);
    }

    .notice-code {
      font-family: monospace;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .notice-title {
      margin: 0.25rem 0;
    }

    .notice-location {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    footer {
      text-align: center;
      margin-top: 3rem;
      padding: 1rem;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    /* Modal styles for file size error */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .modal-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .modal h2 {
      margin-bottom: 1rem;
      color: var(--error);
    }

    .modal p {
      margin-bottom: 1rem;
      color: var(--text-muted);
      line-height: 1.6;
    }

    .modal .file-size {
      font-weight: 600;
      color: var(--text);
    }

    .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1.5rem;
    }

    .modal-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .modal-btn.primary {
      background: var(--primary);
      color: white;
      border: none;
    }

    .modal-btn.primary:hover {
      opacity: 0.9;
    }

    .modal-btn.secondary {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .modal-btn.secondary:hover {
      background: var(--bg);
    }

    .url-zone {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .url-zone h3 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: var(--text-muted);
    }

    .url-input-container {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .url-input-container input {
      flex: 1;
      min-width: 250px;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
    }

    .url-input-container button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      font-size: 1rem;
      transition: opacity 0.2s;
    }

    .url-input-container button:hover {
      opacity: 0.9;
    }

    .divider {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 1.5rem 0;
      color: var(--text-muted);
      font-weight: 500;
      position: relative;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: var(--border);
      margin: 0 1rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>GTFS Validator</h1>
      <p class="subtitle">Validate GTFS feeds entirely in your browser</p>
      <span class="version" id="version">Loading...</span>
    </header>

    <div class="drop-zone" id="dropZone">
      <div class="icon">üì¶</div>
      <p><strong>Drag and drop</strong> a GTFS ZIP file here</p>
      <p>or</p>
      <label class="file-label" for="fileInput">Choose File</label>
      <input type="file" id="fileInput" accept=".zip">
    </div>

    <div class="divider">
      <span>OR</span>
    </div>

    <div class="url-zone">
      <h3>Analyze via URL</h3>
      <div class="url-input-container">
        <input type="text" id="urlInput" placeholder="Enter GTFS URL (e.g. http://site.com/gtfs.zip)">
        <button id="urlAnalyzeBtn">Analyze</button>
      </div>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Validating your GTFS feed...</p>
    </div>

    <div class="results" id="results">
      <div class="summary" id="summary"></div>

      <div class="notices-section">
        <div class="notices-header">
          <h2>Notices</h2>
          <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="ERROR">Errors</button>
            <button class="filter-btn" data-filter="WARNING">Warnings</button>
            <button class="filter-btn" data-filter="INFO">Info</button>
          </div>
        </div>
        <div class="notices-list" id="notices"></div>
      </div>
    </div>

    <footer>
      <p>
        Powered by <a href="https://gtfs.guru" target="_blank">gtfs.guru</a>
        &bull; No data is uploaded &bull; Everything runs locally in your browser
      </p>
    </footer>
  </div>

  <!-- Modal for file size error -->
  <div class="modal-overlay" id="fileSizeModal">
    <div class="modal">
      <div class="modal-icon">‚ö†Ô∏è</div>
      <h2>File Too Large for Browser</h2>
      <p>
        Your GTFS file is <span class="file-size" id="modalFileSize">0</span> MB,
        which exceeds the <strong>50 MB limit</strong> for browser-based validation.
      </p>
      <p>
        WebAssembly (WASM) has memory constraints that limit the size of files
        we can process in the browser. For larger feeds, please use our
        <strong>desktop application</strong>, which has no size limits and
        runs significantly faster.
      </p>
      <div class="modal-buttons">
        <a href="https://github.com/gtfs-validator/gtfs-validator-rust/releases/latest" target="_blank"
          class="modal-btn primary">
          Download Desktop App
        </a>
        <button class="modal-btn secondary" id="modalClose">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Import WASM module - adjust path as needed
    import init, { validate_gtfs, version } from '../pkg/gtfs_guru_wasm.js';

    // Maximum file size for WASM validation (50 MB)
    // Larger files may cause memory issues in the browser.
    // Desktop app has no such limitations.
    const MAX_FILE_SIZE_MB = 50;
    const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_MB * 1024 * 1024;

    let wasmReady = false;
    let allNotices = [];
    let currentFilter = 'all';

    let wasmInitPromise = null;

    async function ensureWasmLoaded() {
      if (wasmReady) return;
      if (!wasmInitPromise) {
        wasmInitPromise = initWasm();
      }
      await wasmInitPromise;
    }

    async function initWasm() {
      try {
        await init();
        wasmReady = true;
        document.getElementById('version').textContent = `v${version()}`;
        console.log('GTFS Validator WASM ready');
      } catch (error) {
        console.error('Failed to initialize WASM:', error);
        document.getElementById('version').textContent = 'Error loading';
        throw error;
      }
    }

    async function validateFile(file) {
      await ensureWasmLoaded();

      // Check file size limit
      const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
      if (file.size > MAX_FILE_SIZE_BYTES) {
        showFileSizeError(fileSizeMB);
        // Reset input so user can try again or select another file
        document.getElementById('fileInput').value = '';
        return;
      }

      const dropZone = document.getElementById('dropZone');
      const loading = document.getElementById('loading');
      const results = document.getElementById('results');

      dropZone.style.display = 'none';
      loading.classList.add('show');
      results.classList.remove('show');

      try {
        const bytes = new Uint8Array(await file.arrayBuffer());
        await runValidation(bytes, file.name);
      } catch (error) {
        console.error('Validation error:', error);
        loading.classList.remove('show');
        dropZone.style.display = 'block';
        alert('Error validating file: ' + error.message);
      } finally {
        // Reset input so user can select the same file again if needed
        document.getElementById('fileInput').value = '';
      }
    }

    async function validateUrl(url) {
      await ensureWasmLoaded();

      const dropZone = document.getElementById('dropZone');
      // ... rest of function ...

      const loading = document.getElementById('loading');
      const results = document.getElementById('results');

      dropZone.style.display = 'none';
      loading.classList.add('show');
      results.classList.remove('show');

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Failed to fetch: ${response.statusText}`);
        }
        const bytes = new Uint8Array(await response.arrayBuffer());

        let filename = 'remote_feed';
        try {
          const urlObj = new URL(url);
          filename = urlObj.pathname.split('/').pop() || 'remote_feed';
        } catch (e) { }

        await runValidation(bytes, filename);
      } catch (error) {
        console.error('URL Validation error:', error);
        loading.classList.remove('show');
        dropZone.style.display = 'block';
        alert('Error loading URL: ' + error.message + '\nNote: Remote servers must allow CORS.');
      }
    }

    async function runValidation(bytes, filename) {
      const loading = document.getElementById('loading');
      const results = document.getElementById('results');

      try {
        const startTime = performance.now();
        const dateStr = new Date().toISOString().split('T')[0];
        const result = validate_gtfs(bytes, undefined, dateStr);
        const elapsed = (performance.now() - startTime).toFixed(0);

        allNotices = JSON.parse(result.json);

        renderSummary(result, elapsed, filename);
        renderNotices();

        loading.classList.remove('show');
        results.classList.add('show');
      } catch (error) {
        throw error;
      }
    }

    // In renderSummary, remove the Valid/Invalid stat
    function renderSummary(result, elapsed, filename) {
      const summary = document.getElementById('summary');
      let html = `
        <div class="stat errors">
          <div class="stat-value">${result.error_count}</div>
          <div class="stat-label">Errors</div>
        </div>
        <div class="stat warnings">
          <div class="stat-value">${result.warning_count}</div>
          <div class="stat-label">Warnings</div>
        </div>
        <div class="stat info">
          <div class="stat-value">${result.info_count}</div>
          <div class="stat-label">Info</div>
        </div>
        <div class="stat">
          <div class="stat-value">${elapsed}</div>
          <div class="stat-label">ms</div>
        </div>
      `;

      // Add Download html button
      if (result.html) {
        html += `
          <div class="stat" style="cursor: pointer;" onclick="downloadHtmlReport()">
             <div class="stat-value">üíæ</div>
             <div class="stat-label">Download Report</div>
          </div>
          `;
        // Store html globally or attached to result
        window.lastReportHtml = result.html;
      }

      summary.innerHTML = html;
    }

    // Add function to download report
    window.downloadHtmlReport = function () {
      if (!window.lastReportHtml) return;
      const blob = new Blob([window.lastReportHtml], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'validation_report.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    function renderNotices() {
      const noticesEl = document.getElementById('notices');
      const filtered = currentFilter === 'all'
        ? allNotices
        : allNotices.filter(n => n.severity === currentFilter);

      if (filtered.length === 0) {
        noticesEl.innerHTML = `
          <div class="empty-state">
            ${currentFilter === 'all'
            ? 'No notices found - your GTFS feed looks great!'
            : `No ${currentFilter.toLowerCase()} notices`}
          </div>
        `;
        return;
      }

      noticesEl.innerHTML = filtered.slice(0, 200).map(notice => {
        // Build context string
        let contextHtml = '';

        // Add primary location fields
        if (notice.filename || notice.file) {
          contextHtml += `<div class="notice-location">File: ${notice.filename || notice.file}</div>`;
        }
        if (notice.csvRowNumber || notice.row) {
          contextHtml += `<div class="notice-location">Row: ${notice.csvRowNumber || notice.row}</div>`;
        }
        if (notice.fieldName || notice.field) {
          contextHtml += `<div class="notice-location">Field: ${notice.fieldName || notice.field}</div>`;
        }

        // Add extra context if available
        if (notice.context) {
          for (const [key, value] of Object.entries(notice.context)) {
            // Skip already checked keys if they are redundant (though mostly they might be different)
            if (!['filename', 'csvRowNumber', 'fieldName', 'file', 'row', 'field'].includes(key)) {
              contextHtml += `<div class="notice-location">${key}: ${value}</div>`;
            }
          }
        }

        return `
        <div class="notice ${notice.severity}">
          <div class="notice-code">[${notice.code}]</div>
          <div class="notice-title">${notice.title || notice.code}</div>
          ${contextHtml}
        </div>
      `}).join('');

      if (filtered.length > 200) {
        noticesEl.innerHTML += `
          <div class="empty-state">
            Showing 200 of ${filtered.length} notices
          </div>
        `;
      }
    }



    // Event handlers
    document.getElementById('fileInput').addEventListener('change', (e) => {
      if (e.target.files[0]) {
        validateFile(e.target.files[0]);
      }
    });

    document.getElementById('urlAnalyzeBtn').addEventListener('click', () => {
      const url = document.getElementById('urlInput').value.trim();
      if (url) {
        validateUrl(url);
      }
    });

    document.getElementById('urlInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const url = document.getElementById('urlInput').value.trim();
        if (url) {
          validateUrl(url);
        }
      }
    });

    const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files[0]) {
        validateFile(e.dataTransfer.files[0]);
      }
    });

    dropZone.addEventListener('click', (e) => {
      // Don't trigger if clicking on the label (which already triggers input natively)
      // OR if the click is coming from the input itself (bubbling up), which would cause an infinite loop/double open
      if (e.target.tagName === 'LABEL' || e.target.closest('label') || e.target.tagName === 'INPUT') {
        return;
      }
      document.getElementById('fileInput').click();
    });

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderNotices();
      });
    });

    // Show file size error modal
    function showFileSizeError(fileSizeMB) {
      document.getElementById('modalFileSize').textContent = fileSizeMB;
      document.getElementById('fileSizeModal').classList.add('show');
    }

    // Close modal handler
    document.getElementById('modalClose').addEventListener('click', () => {
      document.getElementById('fileSizeModal').classList.remove('show');
    });

    // Close modal on overlay click
    document.getElementById('fileSizeModal').addEventListener('click', (e) => {
      if (e.target.id === 'fileSizeModal') {
        document.getElementById('fileSizeModal').classList.remove('show');
      }
    });

    // Initialize
    initWasm();
  </script>
</body>

</html>